@startuml sequence-new-session
title CodingAgent - New Session Startup

actor User
participant "System.CommandLine" as CLI
participant "IHost / DI Container" as DI
participant "NewSessionCommand" as Cmd
participant Agent
participant SessionStore
participant "ILogger" as Log
participant "File System" as FS

User -> CLI : CodingAgent new "Create a calculator app"
activate CLI

note over CLI
  System.CommandLine parses args:
  command = "new"
  task = ["Create", "a", "calculator", "app"]
end note

CLI -> Cmd : SetHandler invoked
activate Cmd

Cmd -> DI : GetRequiredService<Agent>()
DI --> Cmd : Agent instance\n(with all dependencies injected)

note over DI
  DI resolves full graph:
  Agent(
    IOptions<AgentOptions>,
    CommandExecutor,
    CommandParser,
    SessionStore,
    OutboxBuilder,
    ILogger<Agent>)
end note

Cmd -> Agent : StartNewSession("Create a calculator app")
activate Agent

Agent -> Agent : Generate SessionId\n(first 8 chars of GUID)

Agent -> SessionStore : Save(session)
SessionStore -> FS : WriteAllText(temp file)
SessionStore -> FS : Move(temp -> {id}.json)

Agent -> Log : LogInformation("New session: {id}")
Agent -> Log : LogInformation("Task: {task}")

Cmd -> Agent : Run()
ref over Agent, User, FS : See Main Loop Sequence Diagram

deactivate Agent
deactivate Cmd
deactivate CLI

@enduml
